#!/bin/sh
SERVICE_NAME=ptracks-daemon
PID_PATH_NAME=/tmp/ptracks.pid
MCAST_GW=172.17.255.254

case $1 in
    start)
        echo "Starting $SERVICE_NAME ..."
        if [ ! -f $PID_PATH_NAME ]; then
            # sleep 10
            sudo ip route add 224.0.0.0/4 via $MCAST_GW
            cd $NEWTON_PATH
            nohup python -m ptracks.newton 2>> /dev/null >> /dev/null & echo $! > $PID_PATH_NAME
            echo "$SERVICE_NAME started ..."
        else
            echo "$SERVICE_NAME is already running ..."
        fi
    ;;
    stop)
        if [ -f $PID_PATH_NAME ]; then
            PID=$(cat $PID_PATH_NAME);
            echo "$SERVICE_NAME stoping ..."
            sudo ip route del 224.0.0.0/4 via $MCAST_GW
            sudo kill -9 $PID;
            sudo rm $PID_PATH_NAME
            sudo kill -9 `ps -ef | grep "newton" | grep -v grep | awk '{print $2}'`
            echo "$SERVICE_NAME stopped ..."
        else
            echo "$SERVICE_NAME is not running ..."
        fi
    ;;
    restart)
        if [ -f $PID_PATH_NAME ]; then
            PID=$(cat $PID_PATH_NAME);
            echo "$SERVICE_NAME stoping ..."
            sudo ip route del 224.0.0.0/4 via $MCAST_GW
            sudo kill $PID;
            sudo rm $PID_PATH_NAME
            sudo kill -9 `ps -ef | grep "newton" | grep -v grep | awk '{print $2}'`
            echo "$SERVICE_NAME stopped ..."

            sudo ip route add 224.0.0.0/4 via $MCAST_GW
            cd $NEWTON_PATH
            nohup python -m ptracks.newton 2>> /dev/null >> /dev/null & echo $! > $PID_PATH_NAME
            echo "$SERVICE_NAME started ..."
        else
            echo "$SERVICE_NAME is not running ..."
        fi
    ;;
esac
